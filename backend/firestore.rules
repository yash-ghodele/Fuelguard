rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Get Org ID from Custom Claims (High Performance)
    function getOrgId() {
      return request.auth.token.orgId;
    }

    // Get Role from Custom Claims
    function getRole() {
      return request.auth.token.role;
    }

    // Check if user belongs to the target organization
    function isOrgMember(orgId) {
      return isAuthenticated() && getOrgId() == orgId;
    }

    // Role Checks
    function isAdmin() {
      return getRole() == 'admin';
    }

    function isManager() {
      return getRole() == 'manager' || getRole() == 'admin';
    }

    // --- Collection Rules ---

    // Organizations: Only members can read their own org
    match /organizations/{orgId} {
      allow read: if isOrgMember(orgId);
      allow create: if isAuthenticated(); // Allow creating a new org (onboarding)
      allow update: if isOrgMember(orgId) && isAdmin();
      allow delete: if false; // Prevent accidental deletion
    }

    // Invitations: Admin only for creation, Public read for validation (by ID)
    match /invitations/{inviteId} {
      allow read: if isAuthenticated(); // Need to read to accept
      allow create: if isOrgMember(request.resource.data.organizationId) && isAdmin();
      allow update: if isOrgMember(resource.data.organizationId) && isAdmin(); // Cancel invite
      allow delete: if isOrgMember(resource.data.organizationId) && isAdmin();
    }

    // Users: Users can read themselves, Admins can read/manage their org members
    match /users/{userId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == userId || 
        isOrgMember(resource.data.organizationId)
      );
      allow create: if isAuthenticated(); // Initial profile creation
      allow update: if isAuthenticated() && request.auth.uid == userId; // Self-update profile
      allow delete: if isOrgMember(resource.data.organizationId) && isAdmin();
    }

    // Vehicles: RBAC applied
    match /vehicles/{vehicleId} {
      allow read: if isOrgMember(resource.data.organizationId);
      allow create: if isOrgMember(request.resource.data.organizationId) && isManager();
      allow update: if isOrgMember(resource.data.organizationId) && isManager();
      allow delete: if isOrgMember(resource.data.organizationId) && isAdmin();
    }

    // Devices: RBAC applied
    match /devices/{deviceId} {
      allow read: if isOrgMember(resource.data.organizationId);
      allow create: if isOrgMember(request.resource.data.organizationId) && isManager();
      allow update: if isOrgMember(resource.data.organizationId) && isManager();
      allow delete: if isOrgMember(resource.data.organizationId) && isAdmin();
    }

    // Fuel Readings: Read-only for users, Write for Bridge (handled via Admin SDK usually, but if using client SDK need rules)
    // Note: Bridge usually uses Admin SDK which bypasses rules. 
    // If devices write directly (not recommended), we need a different auth strategy.
    // Assuming Bridge writes via Admin SDK.
    match /fuelReadings/{readingId} {
      allow read: if isOrgMember(resource.data.organizationId);
      allow create: if false; // Only Admin SDK (Bridge)
      allow update, delete: if false; // Immutable
    }

    // Alerts: Read-only for most, Managers can acknowledge/resolve
    match /alerts/{alertId} {
      allow read: if isOrgMember(resource.data.organizationId);
      allow create: if false; // Only System/Bridge
      allow update: if isOrgMember(resource.data.organizationId) && isManager();
      allow delete: if isOrgMember(resource.data.organizationId) && isAdmin();
    }

    // Notifications: User specific
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && request.auth.uid == resource.data.userId;
      allow create: if false; // System only
      allow update: if isAuthenticated() && request.auth.uid == resource.data.userId; // Mark read
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.userId;
    }

    // Commands: Managers can send commands
    match /commands/{commandId} {
      allow read: if isOrgMember(resource.data.organizationId);
      allow create: if isOrgMember(request.resource.data.organizationId) && isManager();
      allow update: if false; // Status updates via Bridge only
      allow delete: if isOrgMember(resource.data.organizationId) && isAdmin();
    }
  }
}
